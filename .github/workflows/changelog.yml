name: Update Changelog

on:
  workflow_dispatch:

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - run: npm run changelog
      - name: Create changelog PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global commit.gpgsign false
          git config --global pull.rebase false
          git config --global gpg.program ""
          git config --global core.editor "true"

          if [[ $(git status --porcelain) ]]; then
            # Create a new branch for the changelog
            BRANCH_NAME="changelog-update-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Commit the changelog changes
            git add CHANGELOG.md
            git commit --no-gpg-sign -m "chore: update changelog [skip ci]"
            
            # Push to the new branch
            git push origin "$BRANCH_NAME"
            
            # Create a pull request using GitHub CLI
            gh pr create \
              --title "Update Changelog" \
              --body "Automated changelog update" \
              --base master \
              --head "$BRANCH_NAME"
            
            echo "âœ… Changelog PR created: $BRANCH_NAME"
          else
            echo "No changes to commit"
          fi
